name: X AI Tweet Generator

on:
  schedule:
    - cron: '0 0 * * *'
    - cron: '0 3 * * *'
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  generate-tweet:
    runs-on: ubuntu-latest
    
    permissions:
      issues: write
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Generate tweet
      id: generate
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        python generate_tweet.py
    
    - name: Get current time (JST)
      id: time
      run: |
        echo "jst_time=$(TZ=Asia/Tokyo date +'%Y年%m月%d日 %H:%M')" >> $GITHUB_OUTPUT
    
    - name: Create GitHub Issue
      uses: actions/github-script@v7
      with:
        script: |
          const tweet = process.env.TWEET_CONTENT || 'ツイート生成に失敗しました';
          const charCount = process.env.CHAR_COUNT || '0';
          const jstTime = process.env.JST_TIME || '不明';
          
          const issueBody = [
            '## 📝 生成されたツイート',
            '',
            tweet,
            '',
            '---',
            '',
            '### 📊 詳細情報',
            '',
            '- **文字数**: ' + charCount + '/280',
            '- **生成時刻**: ' + jstTime + ' (JST)',
            '- **ハッシュタグ**: #生成AI #AI',
            '',
            '---',
            '',
            '### ✅ 投稿方法',
            '',
            '1. 上記のツイート内容をコピー',
            '2. [X (Twitter)](https://twitter.com/compose/tweet) にアクセス',
            '3. ツイート内容を貼り付けて投稿',
            '',
            '---',
            '',
            '*このIssueは自動生成されました by GitHub Actions*'
          ].join('\n');
          
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '🐻 くま博士のツイート案 - ' + jstTime,
            body: issueBody,
            labels: ['tweet', 'auto-generated']
          });
          
          console.log('Issue created: #' + issue.data.number);
      env:
        TWEET_CONTENT: ${{ steps.generate.outputs.tweet }}
        CHAR_COUNT: ${{ steps.generate.outputs.char_count }}
        JST_TIME: ${{ steps.time.outputs.jst_time }}
    
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: tweet-logs
        path: tweet_generator.log
        retention-days: 30

