name: X AI Tweet Generator

on:
  schedule:
    - cron: '0 0 * * *'
    - cron: '0 3 * * *'
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  generate-tweet:
    runs-on: ubuntu-latest
    
    permissions:
      issues: write
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Generate tweet
      id: generate
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        python generate_tweet.py
    
    - name: Get current time (JST)
      id: time
      run: |
        echo "jst_time=$(TZ=Asia/Tokyo date +'%Yå¹´%mæœˆ%dæ—¥ %H:%M')" >> $GITHUB_OUTPUT
    
    - name: Create GitHub Issue
      uses: actions/github-script@v7
      with:
        script: |
          const tweet = process.env.TWEET_CONTENT || 'ãƒ„ã‚¤ãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ';
          const charCount = process.env.CHAR_COUNT || '0';
          const jstTime = process.env.JST_TIME || 'ä¸æ˜';
          
          const issueBody = [
            '## ğŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒ„ã‚¤ãƒ¼ãƒˆ',
            '',
            tweet,
            '',
            '---',
            '',
            '### ğŸ“Š è©³ç´°æƒ…å ±',
            '',
            '- **æ–‡å­—æ•°**: ' + charCount + '/280',
            '- **ç”Ÿæˆæ™‚åˆ»**: ' + jstTime + ' (JST)',
            '- **ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°**: #ç”ŸæˆAI #AI',
            '',
            '---',
            '',
            '### âœ… æŠ•ç¨¿æ–¹æ³•',
            '',
            '1. ä¸Šè¨˜ã®ãƒ„ã‚¤ãƒ¼ãƒˆå†…å®¹ã‚’ã‚³ãƒ”ãƒ¼',
            '2. [X (Twitter)](https://twitter.com/compose/tweet) ã«ã‚¢ã‚¯ã‚»ã‚¹',
            '3. ãƒ„ã‚¤ãƒ¼ãƒˆå†…å®¹ã‚’è²¼ã‚Šä»˜ã‘ã¦æŠ•ç¨¿',
            '',
            '---',
            '',
            '*ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ by GitHub Actions*'
          ].join('\n');
          
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸ» ãã¾åšå£«ã®ãƒ„ã‚¤ãƒ¼ãƒˆæ¡ˆ - ' + jstTime,
            body: issueBody,
            labels: ['tweet', 'auto-generated']
          });
          
          console.log('Issue created: #' + issue.data.number);
      env:
        TWEET_CONTENT: ${{ steps.generate.outputs.tweet }}
        CHAR_COUNT: ${{ steps.generate.outputs.char_count }}
        JST_TIME: ${{ steps.time.outputs.jst_time }}
    
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: tweet-logs
        path: tweet_generator.log
        retention-days: 30

